#!/bin/bash

set -u

#DNS_DOMAIN_ID=9609dad3-fc98-451f-9bfc-0978be5733c5

if [ -z $1 ]; then
   echo HODOR need name
   echo HODOR
   exit 1
fi

if [ -z $OS_USERNAME ]; then
   echo HODOR need openstack creds
   echo HODOR
   exit 1
fi

if echo $1 | egrep '(lis|list|lsit)' >/dev/null; then
    nova list
    exit 1
fi

if echo $1 | egrep '\.' >/dev/null ; then
   echo HODOR need bare name like 'testldap'
   echo HODOR
   exit 1
fi

echo HODOR, making vm
echo HODOR, $1.taron.io

id=`nova boot --flavor v1-standard-1 --key-name taron-elessar --image 8d9690dd-e8c1-4fa9-bf40-ed95e630fa55 $1.taron.io | grep -m1 '| id ' | awk '{print $4}'`

echo HODOR, id is $id
sleep 20
ip=`nova show $1.taron.io | awk '/public/ { print $5 }'`
echo HODOR, ip is $ip

echo "HODOR, cloud slow!"

while true; do
if nc -w 4 -v -z $ip 22; then
    break;
fi
echo "HODOR, cloud slow!"
done
ssh -o StrictHostKeyChecking=no ubuntu@$ip

